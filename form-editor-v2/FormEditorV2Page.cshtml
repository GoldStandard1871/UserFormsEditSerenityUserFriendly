@page
@model UserControlForm.Common.Pages.FormEditorV2PageModel
@{
    ViewData["Title"] = "Form Editör V2";
    ViewData["PageId"] = "FormEditorV2";
}

<script>
    alert('Form Editor V2 sayfası yüklendi - Test');
</script>

@section Head {
    <link href="~/Content/FormEditorV2.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Geçici olarak inline CSS ekleyelim */
        .hidden-fields-container {
            display: inline-block;
            position: relative;
            margin-left: 10px;
        }

        .hidden-fields-toggle {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .hidden-fields-toggle:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .hidden-count {
            font-weight: bold;
            color: #dc3545;
        }

        .hidden-fields-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }

        .hide-field-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .slick-cell:hover .hide-field-toggle,
        .form-field:hover .hide-field-toggle {
            opacity: 1;
        }

        .field-width-selector {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 11px;
        }

        .slick-cell {
            position: relative !important;
        }

        .dropdown-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            color: #495057;
        }

        .hidden-fields-list {
            padding: 10px;
        }

        .no-hidden-fields {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }

        .hidden-field-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .hidden-field-item:hover {
            background: #f8f9fa;
        }

        .show-field-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }

        .show-field-btn:hover {
            background: #218838;
        }

        .hidden-field {
            display: none !important;
        }
    </style>
}

<div id="GridDiv"></div>

<div style="position: fixed; top: 10px; right: 10px; z-index: 9999;">
    <button id="addHideButtons" class="btn btn-danger" style="padding: 10px 20px;">
        Alan Gizleme Özelliğini Aktifleştir
    </button>
</div>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Basit test
        console.log('FormEditorV2 sayfası yüklendi');
        
        // Aktifleştir butonuna tıklama
        document.getElementById('addHideButtons').addEventListener('click', function() {
            console.log('Buton tıklandı');
            
            // Form alanlarını bul
            var formFields = document.querySelectorAll('.form-field');
            console.log('Bulunan form alanları:', formFields.length);
            
            if (formFields.length === 0) {
                // Farklı selector'lar dene
                formFields = document.querySelectorAll('[class*="field"]');
                console.log('Alternatif arama sonucu:', formFields.length);
            }
            
            // Her alana basit bir buton ekle
            formFields.forEach(function(field, index) {
                if (!field.querySelector('.simple-hide-btn')) {
                    field.style.position = 'relative';
                    
                    var btn = document.createElement('button');
                    btn.className = 'simple-hide-btn';
                    btn.innerHTML = 'X';
                    btn.style.cssText = 'position: absolute; top: 0; right: 0; background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; z-index: 1000;';
                    
                    btn.onclick = function() {
                        field.style.display = 'none';
                        alert('Alan gizlendi!');
                    };
                    
                    field.appendChild(btn);
                }
            });
            
            alert('İşlem tamamlandı. ' + formFields.length + ' alana buton eklendi.');
        });
    });
    
    // Eski grid kodları
    var grid;
    var hiddenFields = {};
    
    $(function () {
        // Mevcut grid'i başlat
        grid = new UserControlForm.FormEditorV2Grid($('#GridDiv'));
        grid.init();
    });
    
    function addFieldHideFeatures() {
        // Toolbar'a gizlenen alanlar dropdown'unu ekle
        var toolbar = $('.s-Toolbar').first();
        if (toolbar.length && !toolbar.find('.hidden-fields-container').length) {
            var hiddenFieldsHtml = `
                <div class="hidden-fields-container" style="display: inline-block; margin-left: 20px; position: relative;">
                    <button class="hidden-fields-toggle btn btn-info" onclick="toggleHiddenFields(event)">
                        <i class="fa fa-eye-slash"></i> Gizlenen Alanlar <span class="hidden-count">(0)</span>
                    </button>
                    <div class="hidden-fields-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.2); min-width: 300px; z-index: 1000; margin-top: 5px; border-radius: 4px;">
                        <div class="dropdown-header" style="padding: 10px; background: #f0f0f0; font-weight: bold; border-bottom: 1px solid #ddd;">Gizlenen Alanlar</div>
                        <div class="hidden-fields-list" style="padding: 10px; max-height: 300px; overflow-y: auto;">
                            <div class="no-hidden-fields" style="color: #999; text-align: center; padding: 20px;">Gizlenmiş alan yok</div>
                        </div>
                    </div>
                </div>
            `;
            toolbar.append(hiddenFieldsHtml);
        }
        
        // Her form alanına gizle butonu ekle
        $('.form-field').each(function() {
            var field = $(this);
            if (!field.find('.hide-field-btn').length) {
                var fieldName = field.find('label').first().text().replace('*', '').trim();
                var fieldId = 'field_' + Math.random().toString(36).substr(2, 9);
                field.attr('data-field-id', fieldId);
                field.attr('data-field-name', fieldName);
                field.css('position', 'relative');
                
                var hideBtn = $(`
                    <button class="hide-field-btn" onclick="hideField('${fieldId}')" 
                        style="position: absolute; top: 5px; right: 5px; background: #fff; 
                        border: 1px solid #ddd; padding: 2px 8px; font-size: 11px; 
                        cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 10; border-radius: 3px;">
                        <i class="fa fa-eye-slash"></i>
                    </button>
                `);
                
                field.append(hideBtn);
                
                // Hover efekti
                field.hover(
                    function() { hideBtn.css('opacity', '1'); },
                    function() { hideBtn.css('opacity', '0'); }
                );
            }
        });
    }
    
    function toggleHiddenFields(event) {
        event.stopPropagation();
        var dropdown = $('.hidden-fields-dropdown');
        dropdown.toggle();
        if (dropdown.is(':visible')) {
            updateHiddenFieldsList();
        }
    }
    
    function hideField(fieldId) {
        var field = $('[data-field-id="' + fieldId + '"]');
        var fieldName = field.attr('data-field-name') || field.find('label').first().text().replace('*', '').trim();
        
        field.hide();
        hiddenFields[fieldId] = fieldName;
        updateHiddenCount();
        updateHiddenFieldsList();
    }
    
    function showField(fieldId) {
        var field = $('[data-field-id="' + fieldId + '"]');
        field.show();
        delete hiddenFields[fieldId];
        updateHiddenCount();
        updateHiddenFieldsList();
    }
    
    function updateHiddenCount() {
        var count = Object.keys(hiddenFields).length;
        $('.hidden-count').text('(' + count + ')');
    }
    
    function updateHiddenFieldsList() {
        var list = $('.hidden-fields-list');
        list.empty();
        
        var fieldIds = Object.keys(hiddenFields);
        if (fieldIds.length === 0) {
            list.html('<div class="no-hidden-fields" style="color: #999; text-align: center; padding: 20px;">Gizlenmiş alan yok</div>');
        } else {
            fieldIds.forEach(function(fieldId) {
                var item = $(`
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #333;">${hiddenFields[fieldId]}</span>
                        <button class="btn btn-sm btn-success" onclick="showField('${fieldId}')" style="padding: 2px 10px; font-size: 12px;">
                            <i class="fa fa-eye"></i> Göster
                        </button>
                    </div>
                `);
                list.append(item);
            });
        }
    }
    
    // Dropdown dışına tıklandığında kapat
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.hidden-fields-container').length) {
            $('.hidden-fields-dropdown').hide();
        }
    });
    
    function testButton() {
        alert('Test butonu çalışıyor! Form field sayısı: ' + $('.form-field').length);
        console.log('Form fields:', $('.form-field'));
        console.log('Toolbar:', $('.s-Toolbar'));
        
        // Form field'larını tekrar tara ve butonları ekle
        addFieldHideFeatures();
    }
</script>